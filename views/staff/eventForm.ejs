<!-- views/admin/users.ejs -->
<% include ../../partials/header %>
<!--<script src='/public/js/eventForm.js'></script>-->
<link rel='stylesheet' href='/public/css/eventForm.css' />
<% getPrices(flowers); %>

	<div class="page-header text-center">
		<h1><span class="fa fa-calendar"></span> Event Form</h1>
	</div>

  <form action="/staff/eventForm" method="post">
		<h2 id="GeneralInfo">Customer & General Info</h2>
		<div class="row">
			<div class="form-group col-sm-4">
				<label>Customer</label>
				<select class="form-control" name="customer">
					<% printCustomers(customers); %>
				</select>
			</div>
			<div class="form-group col-sm-4">
				<label>Bride's Name</label>
				<input type="text" class="form-control" name="brides-name">
			</div>
			<div class="form-group col-sm-4">
				<label>Groom's Name</label>
				<input type="text" class="form-control" name="grooms-name">
			</div>
		</div>

		<hr>

		<h2 id="CeremonyInfo">Ceremony Info</h2>
		<div class="row">
			<div class="form-group col-sm-6">
					<label>Date</label>
					<input type="text" class="form-control date" name="ceremony-date">
			</div>
			<div class="form-group col-sm-6">
				<label>Start Time</label>
				<select class="form-control" name="ceremony-start-time">
					<% printTimes(); %>
				</select>
			</div>
		</div>
		<div class="row">
			<div class="form-group col-sm-3">
				<label>Address</label>
				<input type="text" class="form-control" name="ceremony-address">
			</div>
			<div class="form-group col-sm-3">
				<label>City</label>
				<input type="text" class="form-control" name="ceremony-city">
			</div>
			<div class="form-group col-sm-3">
				<label>State</label>
				<input type="text" class="form-control" name="ceremony-state">
			</div>
			<div class="form-group col-sm-3">
				<label>Zip</label>
				<input type="text" class="form-control" name="ceremony-zip">
			</div>
		</div>
		<div class="row">
			<div class="form-group col-sm-6">
				<label>Colors</label><br>
				<textarea name="color-notes"></textarea>
			</div>
			<div class="form-group col-sm-6">
				<label>Theme</label><br>
				<textarea name="theme-notes"></textarea>
			</div>
		</div>

		<hr>
		<!-- RECEPTION -->

		<h2 id="ReceptionInfo">Reception Info</h2>
		<div class="row">
			<div class="form-group col-sm-6">
					<label>Date</label>
					<input type="text" class="form-control date" name="reception-date">
			</div>
			<div class="form-group col-sm-6">
				<label>Start Time</label>
				<select class="form-control" name="reception-start-time">
					<% printTimes(); %>
				</select>
			</div>
		</div>
		<div class="row">
			<div class="form-group col-sm-3">
				<label>Address</label>
				<input type="text" class="form-control" name="reception-address">
			</div>
			<div class="form-group col-sm-3">
				<label>City</label>
				<input type="text" class="form-control" name="reception-city">
			</div>
			<div class="form-group col-sm-3">
				<label>State</label>
				<input type="text" class="form-control" name="reception-state">
			</div>
			<div class="form-group col-sm-3">
				<label>Zip</label>
				<input type="text" class="form-control" name="reception-zip">
			</div>
		</div>

<hr>
<h2 id="PhotographyPlannerDelivery">Photography, Planner, & Delivery</h2>
<div class="row">
	<div class="form-group col-sm-6">
		<label>Photographers</label>
		<input type="text" class="form-control" name="photographers">
	</div>
	<div class="form-group col-sm-6">
		<label>Photography Start Time</label>
		<select class="form-control" name="photograph-start-time">
			<% printTimes(); %>
		</select>
	</div>
</div>
<div class="row">
	<div class="form-group col-sm-6">
		<label>Wedding Planner</label>
		<input type="text" class="form-control" name="wedding-planner">
	</div>
	<div class="form-group col-sm-6">
		<label>Delivery Time</label>
		<select class="form-control" name="delivery-time">
			<% printTimes(); %>
		</select>
	</div>
</div>

		<hr>

		<%
			printRecipeSection("Bouquets",["Bridal","Bridesmaids","Throw"]);
			printRecipeSection("Boutonnieres",["Groom","Groomsmen","Ushers","Fathers","Grandfathers","Ring Bearers","Officiant","Vocalist","Hosts","Reader","Musician","Other"]);
			printRecipeSection("Corsages",["Mothers","Guest Book","Cake Cutter","Reader","Vocalist","Hostess","Musician","Flower Girl","Other"]);
			printRecipeSection("Ceremony Decorations",["Altar","Aisle","Guest Book","Unity Candle","Other"]);
			printRecipeSection("Reception Decorations",["Centerpieces","Head Table","Bar Flowers","Guest book","Cake Flowers","Other"]);
		%>

		<!-- Add Item Modal -->
		<div class="container">

			<div class="modal fade" id="mdlAddItem" role="dialog">
				<div class="modal-dialog">

					<div class="modal-content">
						<div class="modal-header" style="padding:32px 32px;">
							<button type="button" class="close" data-dismiss="modal">&times;</button>
							<h4>Add Item</h4>
						</div>
						<div class="modal-body" style="padding:48px 48px;">
							<form name="formEditInventory" role="form" attribute="">
								<div class="form-group">
									<input class="modal-hidden-table" id="modal-table-id" type="hidden" value="" />
									<label>Item</label>
									<select class="form-control" name="altar-flowers" id="altar-flowers" style="width: 200px; display: inline;"><% printFlowers(flowers); %></select>&nbsp;
									<label style="display: inline;">Quantity</label>&nbsp;
									<input name="addQuanitiy" id="addQuantity" type="number" min="1" step="1" style="width: 40px; display: inline;" />
									<label style="display: inline;">$ Price</label>&nbsp;
									<input name="addPrice" id="addPrice" style="width: 75; display: inline;" type="number" min="0" min="0.00" step="0.01" class="form-control";>
								</div>
								<br><br>
								<div>
									<button type="submit" class="btn btn-danger btn-default pull-left" data-dismiss="modal">Cancel</button>
									<button type="submit" class="btn btn-success btn-default pull-right" id="addItem">Add</button>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div id="side-bar">
			<img class="logo" src="/public/img/logo.jpg" width="198px"></img>
			<!-- Grand Total -->
			<table class="itemTable" id="grand-total-table" cellspacing="0" width="100%">
				<thead>
					<th>Grand Total</th>
				</thead>
				<tbody>
					<td id="grand-total" style="text-align: center">$0.00</td>
				</tbody>
			</table>

			<ul id="floating-side-nav" class="floating-side-nav">
				<li><a href="javascript:navigationFn.goToSection('#GeneralInfo');">Customer & General Info</a></li>
				<li><a href="javascript:navigationFn.goToSection('#CeremonyInfo');">Ceremony Info</a></li>
				<li><a href="javascript:navigationFn.goToSection('#ReceptionInfo');">Reception Info</a></li>
				<li><a href="javascript:navigationFn.goToSection('#PhotographyPlannerDelivery');">Photography, Planners, & Delivery</a></li>
				<li><a href="javascript:navigationFn.goToSection('#Bouquets');">Boquets</a></li>
				<li><a href="javascript:navigationFn.goToSection('#Boutonnieres');">Boutonnieres</a></li>
				<li><a href="javascript:navigationFn.goToSection('#Corsages');">Corsages</a></li>
				<li><a href="javascript:navigationFn.goToSection('#CeremonyDecorations');">Ceremony Decorations</a></li>
				<li><a href="javascript:navigationFn.goToSection('#ReceptionDecorations');">Reception Decorations</a></li>
			</ul>

			<!-- save -->
			<input class="btn btn-primary" id="save-btn" type="submit" value="Save"></input>
		</div>

  </form>

  <% include ../../partials/footer %>

<% function printTimes() { %>
	<% var minutes = ["00","15","30","45"]; %>
	<% for(var i = 0; i <=23; i++) { %>
		<% for(var j = 0; j < minutes.length; j++) {
			var suffix = (i >= 12)? 'pm' : 'am';
			var hours = (i > 12) ? i - 12 : i;
			if(hours == 0) {
				hours = 12;
			} %>
			<option value="<%= hours + minutes[j] + suffix %>"><%= hours + ":" + minutes[j] + " " + suffix%></option>
		<% } %>
	<% } %>
<% } %>

<% function printFlowers(flowers) { %>
	<option value="">Select Flower...</option>
	<% flowers.forEach(function(item, index) { %>
			<option value="<%= item.id %>"><%= item.name %></option>
	<% }); %>
<% } %>

<% function printCustomers(customers) { %>
	<% customers.forEach(function(item, index) { %>
			<option value="<%= item.id %>"><%= item.lastName + ', ' + item.firstName %></option>
	<% }); %>
<% } %>

<% function getPrices(flowers) { %>
	<script>
		var prices = {};
	</script>
	<% flowers.forEach(function(item, index) { %>
			<script>
				prices['<%= item.name %>'] = <%= item.price %>;
			</script>
	<% }); %>
<% } %>

<% function printRecipeSection(heading, subSections) { %>
	<% strippedHeading = heading.replace(/\s+/g, ''); %>
	<h2 id="<%= strippedHeading %>"><%= heading %></h2>

	<% for(var i = 0; i < subSections.length; i++) { %>
		<% strippedSubSection = subSections[i].replace(/\s+/g, ''); %>
		<div class="row">
			<div class="form-group col-sm-6">
				<label><%= subSections[i] %></label><br>

				<input type="button" class='add-btn btn btn-primary' id="add-<%= strippedHeading %>-<%= strippedSubSection %>" value="Add" />
				<table class="itemTable" id="<%= strippedHeading %>-<%= strippedSubSection %>-table" cellspacing="0" width="100%">
					<thead>
						<th>Item</th>
						<th>Qty</th>
						<th>Price (each)</th>
						<th>Remove</th>
					</thead>
					<tbody>
					<tr class='recipeTotal'>
						<td class='item' colspan='2'><b>Total<b></td>
						<td class='price' colspan='2'><b>$0.00<b></td>
					</tr>
				</tbody>
				</table>
			</div>
			<div class="form-group col-sm-6">
				<label>Qty</label>
				<input type="number" min="0" class="form-control" name="<%= strippedHeading %>-<%= strippedSubSection %>-qty">
			</div>
			<div class="form-group col-sm-6">
				<label>Notes</label>
				<textarea name="<%= strippedHeading %>-<%= strippedSubSection %>-notes"></textarea>
			</div>
		</div>

		<% if(i < subSections.length - 1) { %><hr class="dotted"><% } %>

	<% } %>

	<hr>
<% } %>

<script>
$( document ).ready(function() {
	$(".date").datepicker();

	// Display "add inventory" modal.
	$(".add-btn").on('click', function() {
			var tblID = $(this).next('table').attr('id');
			$('#modal-table-id').val(tblID);
			$("#mdlAddItem").modal();
	});

	// Load price on item select
	$("#altar-flowers").on('change', function()	{
		if ($(this).prop('selectedIndex') != 0)	{
			var name = $("option:selected", this).text();
			var price = parseFloat(prices[name]).toFixed(2);
			$(this).siblings('#addPrice').val(price);
			$(this).siblings('#addQuantity').val(1);
		}
		else {
			$(this).siblings('#addPrice').val(price);
			$(this).siblings('#addQuantity').val(null);
		}
	});

	// Add new item to recipe table
	$("#addItem").on('click', function()	{
		if ($("#altar-flowers").prop("selectedIndex") != 0)	{
			event.preventDefault();

			var $form = $(this).closest('form');
			var item = $form.find('#altar-flowers option:selected').text();
			var qty = $form.find('#addQuantity').val();
			var price = $form.find('#addPrice').val();
			price = parseFloat(price);
			var tblID = $form.find('#modal-table-id').val();
			var tbl = $("#" + tblID);
			tbl.prepend("<tr><td>" + item + "</td><td style='text-align: right;'>" + qty + " x </td><td>$" + price.toFixed(2) + "</td><td><center><input type='button' class='remove-item-btn' value='x' /></ center></td></tr>");
			var qtyPrice = parseFloat(qty) * parseFloat(price);
			var tblTotal = tbl.find('.price');
			var initPrice = tblTotal.text();
			initPrice = initPrice.replace(/[,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
			totalToDisp = parseFloat(initPrice) + parseFloat(qtyPrice);
			tblTotal.html("<b>$" + totalToDisp.toFixed(2) + "</b>");
			$("#mdlAddItem").modal('hide');

			updateGrandTotal(totalToDisp, "add")
		}
		else {
			event.preventDefault();
			alert("Please select a valid item.");
		}
	});

	// Save event (parse page and send it to backend).
	$(".save-btn").on('click', function() {
		var $body = $(this).closest('body');
		event.preventDefault();
		// Display wait animation if needed.
		$.ajax({
			url: '/staff/eventForm',
			data: $body.serialize(),
			method: 'POST',
			success: function(response) {
				response = JSON.parse(response);
				alert(response.message);
			}
		})
	});

	// Remove item from recipe table
	$(document).on("click", ".remove-item-btn", function ()	{
		event.preventDefault();
		var parentTbl = $(this).closest('table');
		var rowClicked = $(this).closest('tr');
		var initQty = $(this).closest('td').prev('td').prev('td').text().replace(" x","");
		initQty = parseFloat(initQty);
		var pricePerItem = $(this).closest('td').prev('td').text();
		pricePerItem = pricePerItem.replace(/[,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
		pricePerItem = parseFloat(pricePerItem);
		var currTblTotal = parentTbl.find('.price').text();
		currTblTotal = currTblTotal.replace(/[,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
		currTblTotal = parseFloat(currTblTotal);
		var newTotal = currTblTotal - pricePerItem;
		parentTbl.find('.price').html('<b>$' + newTotal.toFixed(2) + '</b>');
		updateGrandTotal(pricePerItem, "subtract")
		if (initQty > 1)	{
			var newQty = initQty - 1;
			$(this).closest('td').prev('td').prev('td').text(newQty + ' x');
		}
		else {
			rowClicked.remove();
		}
	});

	function updateGrandTotal(price, operator) {
		var currTblTotal = $('#grand-total').text();
		currTblTotal = currTblTotal.replace(/[,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
		currTblTotal = parseFloat(currTblTotal);
		var newTotal = currTblTotal;
		if(operator == "add") {
			newTotal += price;
		} else if (operator == "subtract") {
				newTotal -= price;
		}
		$('#grand-total').html('<b>$' + newTotal.toFixed(2) + '</b>');
	}
});
</script>

<!--
General information:
Date of wedding
Brides Name
Grooms Name
Email Address
Phone number(s)
Physical Address
Ceremony Location
Ceremony start time

Reception Location
Reception start time

Other
Photographer start time
Wedding Planner

Delivery time

Recipe Categories: (Recipe, pricing, design notes)
Bridal bouquet
Bridesmaids (total number=#)
Throw bouquet
Boutonnieres:
    Groom,
    Groomsmen (#)
    Ushers (#)
    Fathers (#)
    Grandfathers(#)
    Ring Bearers (#)
    Officiant
    Vocalist
    Hosts
    Reader
    Musician
Corsages:
    Mothers (#)
    Grandmothers(#)
    Guest Book (#)
    Cake Cutter(#)
    Reader
    Vocalist
    Hostess
    Musician
    Flower Girl (#)
Ceremony Decorations
    Altar (#)
    Aisle decorations
    Guest Book
    Candelabras
    Unity Candle
Reception Decorations
    Centerpieces (#) [**Often this category might have 1-4 different styles         so multiple entries will be needed for different recipes**]
    Head Table
    Bar Flowers
    Guest book
    Cake Flowers
    Other [**would like to be able to add a category should a bride be         doing something unique I can add that in easily**]
-->
